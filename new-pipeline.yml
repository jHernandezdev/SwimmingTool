parameters:
  - name: pathToFiles
    type: string
  - name: artifactName
    type: string

trigger: none

stages:
- stage: build
  jobs:
  - job: run_build
    pool:
      vmImage: 'ubuntu-latest'
    steps:   
    - publish: '$(Build.SourcesDirectory)/${{ parameters.pathToFiles }}'
      displayName: 'Publish script'
      artifact: ${{ parameters.artifactName }}

- stage: test
  dependsOn: build
  jobs:
  - job: run_test
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - download: current
      artifact: ${{ parameters.artifactName }}
      
    - task: AzurePowerShell@5
      inputs:
        azureSubscription: 'Visual Studio Enterprise Subscription (2e763394-a7c4-49b0-845f-15f7caf388c5)'
        ScriptType: 'InlineScript'
        Inline: |
          $bicepFiles = (Get-ChildItem '$(Pipeline.Workspace)/${{ parameters.pathToFiles }}' -Filter *.bicep).FullName
          foreach($biceFile in $bicepFiles) {
              $bicepParamFile = $biceFile.Substring(0, $biceFile.Length - 5) + "json"
              $bicepParamFileBicep = $biceFile + "param"
              New-AzResourceGroupDeployment -ResourceGroupName "jmhh-rsg-core" -TemplateFile $biceFile -TemplateParameterFile $bicepParamFile -environment: "DEV"
          }
        azurePowerShellVersion: 'LatestVersion'
        pwsh: true
