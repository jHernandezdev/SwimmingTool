parameters:
  - name: pathToFiles
    type: string
  - name: artifactName
    type: string

trigger: none

stages:
- stage: build
  jobs:
  - job: run_build
    pool:
      vmImage: 'ubuntu-latest'
    steps:   
    - publish: '$(Build.SourcesDirectory)/${{ parameters.pathToFiles }}'
      displayName: 'Publish script'
      artifact: ${{ parameters.artifactName }}

- stage: test
  dependsOn: build
  jobs:
  - job: run_test
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - download: current
      artifact: ${{ parameters.artifactName }}
      
    - powershell: |
        $bicepFiles = Get-ChildItem '$(Pipeline.Workspace)/${{ parameters.pathToFiles }}' | Select FullName
        echo "##vso[task.setvariable variable=bicepFiles;]$bicepFiles"
        # $directoryInfo.count
        # foreach($file in $directoryInfo)
        # {          
        #   $file.FullName
        # }
      displayName: 'PowerShell Script'
    - ${{ each value in variables.bicepFiles }}:
      - script: echo ${{ value.FullName }}
      
    - bash: |
        echo "You can use macro syntax for variables: $(bicepFiles)"
